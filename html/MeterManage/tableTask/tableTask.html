<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>任务处理-换表/移改提/校表</title>
    <link rel="stylesheet" type="text/css" href="../../public/css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../public/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../public/css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../public/css/vant.css" />

    <style>
        html,
        body {
            width: 100%;
            height: calc(100% - .3rem);
            background-color: #F3F3F3;
        }

        .ri {
            float: right
        }

        .le {
            float: left;
        }

        .cl {
            clear: both;
        }

        .aui-bar-nav {
            top: 0;
            z-index: 1;
            background: linear-gradient(90deg, rgba(46, 142, 250, 1), rgba(49, 89, 235, 1));
            color: #FFF;
            font-size: 0.95rem;
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0rem;
        }

        .aui-bar-nav .aui-btn .aui-iconfont {
            color: #FFF;
            font-size: 0.95rem;
        }

        .aui-bar-nav .aui-pull-right {
            font-size: 0.95rem;
        }

        [v-cloak] {
            display: none;
        }

        .flex-con {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            background-color: #F3F3F3;
        }

        .van-field__label {
            font-size: 0.9rem;
            color: #1F1F1F;
        }

        .van-field__control[type=text] {
            height: auto;
            line-height: inherit;
            font-size: 0.9rem;
            color: #626262;
        }

        .unusualTypePicker.van-cell {
            padding: 0 1.3rem;
            height: 2.87rem;
            line-height: 2.87rem;
        }

        .aui-list-item,
        .aui-list-item-middle {
            border: none !important
        }

        .footer {
            width: 100vw;
            height: 6.08rem;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.35rem;
            bottom: 0;
        }

        .footer .van-button {
            width: 5.5rem;
            height: 1.86rem;
            line-height: normal;
            font-size: 0.90rem;
            color: #fff;
        }

        .footer .van-button:first-child {
            background-color: #377EFF;
        }

        .footer .van-button:last-child {
            background-color: #FF4141;
            border-color: #FF4141;
        }

        #wrap {
            height: 100%;
        }

        .aui-content {
            height: 100%;
        }

        .content {
            margin: .5rem 1rem;
            background-color: #fff;
            border-radius: 0.8rem;
            padding-top: .5rem;
            padding-bottom: .9rem;
        }

        .row {
            /*margin: 0.6rem 25px 0 25px;*/
            margin: 0rem 25px 0rem 25px;
            line-height: 2rem;
            border-bottom: 1px solid #F2F2F2;
        }
        /*.text-left {
            font-size: 0.9rem;
            color: #000;
            display: inline-block;
            width: 38%;
            letter-spacing: -1px;
        }*/

        .text-left {
            width: 38%;
            font-size: 0.9rem;
            display: inline-block;
        }

        .text-left-title {
          display: inline-block;
          text-align: justify;
          text-align-last: justify;
          width: 95%;
        }

        .text-right {
            margin-left: 0px;
            font-size: 0.9rem;
            color: #656265;
            display: inline-block;
            width: calc(60% - 0px);
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            vertical-align: top;
            padding-left: 0.2rem;
        }

        .cause {
            white-space: inherit;
        }

        .textColor {
            color: #2045FF;
        }

        .textarea {
            border: 1px solid #D8D8D8;
            border-radius: 0.13rem;
            /*margin-top: 0.4rem;*/
            padding: 0.25rem 0.5rem;
            color: #626262;
        }

        .images {
            vertical-align: text-top;
        }

        .images>img {
          width: 1.05rem;
          height: 0.85rem;
        }

        .photoList {
            margin-top: 8px;
            margin-bottom: 14px;
        }

        .phont {
            width: 3.6rem;
            height: 2.8rem;
            position: relative;
            display: inline-block;
            margin-right: .7rem;
        }

        .phont img {
            width: 100%;
            height: 100%;
        }

        .delectImg {
            background: url(../image/MeterManage/shanchu@2x.png) no-repeat 0 0;
            background-size: 100% 100%;
            width: .8rem;
            height: .8rem;
            display: inline-block;
            position: absolute;
            right: -7px;
            top: -7px;
        }

        .addressIcon {
            background: url(../image/MeterManage/dingwei.png) no-repeat 0 0;
            background-size: 100% 100%;
            width: .6rem;
            height: .7rem;
            display: inline-block;
        }

        .exTableBtn .van-button {
            font-size: 0.8rem;
            line-height: 1.1rem;
            padding: 0.3rem 1.2rem;
            border-radius: 4px;
        }

        .disposeRow {
            margin-top: .5rem;
        }

        .textRight {
            text-align: right;
        }
        /*下拉弹窗样式修改*/

        .popup {
            max-height: 35vh;
        }

        .pickerMain {
            background-color: #fff;
            padding: 0;
        }

        .van-search .van-field__body,
        .van-form .van-field__body {
            border-bottom: 0.03rem solid #D8D8D8;
        }

        .van-form .van-field {
            width: 5 rem !important;
            color: blue;
        }

        .picker {
            width: 100vw;
            height: 2.13rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.85rem;
            color: #5A5A5A;
            background-color: #fff;
            border-bottom: 0.03rem solid #EDEDED;
        }

        .picker:last-child {
            border-bottom: none;
        }

        .picker.active {
            background-color: #F4F4F4;
            color: #2F81F6;
        }

        .popupFooter {
            width: 100vw;
            height: 2.46rem;
            border-top: 0.25rem solid #ECECEC;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.85rem;
            color: #5A5A5A;
            background-color: #fff;
        }

        .flex-con .van-cell.formField,
        .searchInput,
        .van-form .van-cell.formField,
        .textAreaLabel,
        .locationRow {
            padding: 0.4rem 0.95rem 0.4rem 1.25rem;
            background-color: transparent;
        }

        .van-form .van-cell.formField {}

        .van-form .van-field__label {
            width: 5.8rem !important;
        }

        .van-form .van-field_required {
            font-size: 60px !important;
        }

        .van-form .required-class {
            font-size: 30px !important;
        }
        /*下拉弹窗样式修改*/

        .slMessage {
            /*margin: .6rem 1.2rem .2rem 1.2rem;
            padding-bottom: .5rem;*/
            margin: 0 1.2rem 0 1.2rem;
            border-top: 2px solid #DEDEDE;
            border-bottom: 2px solid #DEDEDE;
        }

        .slMessage .row {
            margin-left: 0;
            margin-right: 0;
        }
        /*延期申请弹窗样式*/

        .popTitle {
            text-align: center;
            border-bottom: 1px solid #2777FF;
            padding: .9rem 1rem;
            margin: 0 1rem;
        }

        .popTitle p {
            color: #2074FF;
            font-size: 1.0rem;
        }

        .timeType .van-radio-group {
            display: inline-block;
            ;
            width: 100%;
            font-size: 0.85rem;
            color: #414141;
        }

        .timeValue .timeField .van-field__control[type=text] {
            height: auto;
            line-height: inherit;
            font-size: 0.75rem;
            color: #D4D4D4;
        }

        .timeValue .timeField .active .van-field__control[type=text] {
            color: #3883FF;
        }

        .timeValue .timeField .van-cell {
            padding: 0.5rem 0.2rem;
            border-bottom: 0.03rem solid #C9C9C9;
            margin: 0 1.1rem;
            width: calc(100% - 2.2rem);
        }

        .timeValue .timeField .van-cell.active {
            border-color: #347CFF
        }

        .disposeRow .van-field {
            width: calc(100% - 2.0rem);
            margin: 0 1.0rem .5rem 1rem;
            border: 1px solid #DEDEDE;
        }

        .timeSelect {
            padding: 1.3rem 0.98rem;
        }

        .van-dialog {
            border-radius: 0;
            width: 86vw;
        }

        .van-dialog .van-button {
            font-size: 0.95rem;
            height: 2.75rem;
            line-height: 2.75rem;
        }

        .van-dialog__confirm,
        .van-dialog__confirm:active {
            color: #2F7DF5;
        }

        .van-dialog__cancel,
        .van-dialog__cancel:active {
            color: #F52F2F;
        }
        /*延期申请弹窗样式*/

        .audio-popup {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            position: fixed;
            z-index: 999;
        }

        .audio-img {
            width: 25%;
            position: absolute;
            left: 37.5%;
            bottom: 20%;
        }

        .audio-popup p {
            width: 100%;
            text-align: center;
            margin-top: 50%;
            font-size: 36px;
            color: #CCC;
        }

        .audio-time-div {
            width: 100%;
            height: 1.5rem;
            text-align: center;
            line-height: 1.5rem;
            font-size: 18px;
            color: #CCC;
            margin-top: 0.5rem;
        }

        .audio-time-div span {
            margin-right: 8px;
            font-size: 36px;
            color: rgba(0, 210, 123, 1);
        }

        .fj-item {
            display: inline-block;
            width: 30%;
            text-align: center;
            font-size: 0.8rem;
            color: #707070;
            position: relative;
        }

        .video-div {
            margin-right: 5%;
        }

        .img-delete {
            position: absolute;
            right: -8px;
            top: -8px;
        }
        .a-text-left{
          color: blue;
          text-decoration: underline;
        }
        .not_border_bottom{
          border-bottom: none;
        }
    </style>
</head>

<body>
    <div id="wrap" class="flex-wrap flex-vertical" v-cloak v-swipeleft="openUserDetails">
        <header class="aui-bar aui-bar-nav" id="header">
            <div class="aui-pull-left aui-btn" tapmode @click='back'>
                <span class="aui-iconfont aui-icon-left"></span>
            </div>
            <div class="aui-title">任务处理</div>
        </header>

        <van-popup class="popup" v-model="showPicker" position="bottom" @closed="hideAllSelect">
            <div class="flex-wrap flex-vertical">
                <div class="flex-con pickerMain" v-if="showAreaSelect">
                    <div class="picker" v-for="(item,index) in cutWater" :key="index" :class="{active:causeTextId == item.id}" @click="causeText=item.name;causeTextId=item.id;showPicker=false">
                        {{item.name}}
                    </div>
                </div>
                <div class="flex-con pickerMain" v-if="showResultSelect">
                    <div class="picker" v-for="(item,index) in addResult" :key="index" :class="{active:resultTextId == item.id}" @click="resultText=item.name;resultTextId=item.id;showPicker=false">
                        {{item.name}}
                    </div>
                </div>
                <div class="popupFooter" @click="hideAllSelect">
                    取消
                </div>
            </div>
        </van-popup>

        <!-- 延期申请弹窗 -->
        <van-dialog v-model="showTimePicker" title="" show-cancel-button :before-close="beforeClose">
            <div class="popTitle">
                <p>申请延期</p>
            </div>
            <div class="timeType">
                <van-row class="disposeRow">
                    <van-col span="8" style="text-align:right;font-size:0.85rem;">
                        延期日期:
                    </van-col>
                    <van-col span="14"></van-col>
                </van-row>
                <div class="timeField disposeRow">
                    <van-datetime-picker style="width: calc(100% - 2rem);margin: 0 1.0rem .5rem 1rem;" v-show="true" v-model="currentDate" :min-date="minTime" type="datetime" :show-toolbar="false" item-height="32" visible-item-count="4"></van-datetime-picker>
                </div>
            </div>
            <div class="timeValue">
                <van-radio-group>
                    <van-row class="disposeRow">
                        <van-col span="8" style="text-align:right;font-size:0.85rem;">
                            申请原因:
                        </van-col>
                        <van-col span="14"></van-col>
                    </van-row>
                    <van-row class="disposeRow">
                        <van-col span="24">
                            <van-field class="applyCause" v-model="dayHourText" border='true' rows="3" type="textarea" maxlength="100" placeholder="请填写申请原因" show-word-limit />
                        </van-col>
                    </van-row>
                </van-radio-group>
            </div>
        </van-dialog>

        <!-- 退回备注弹窗 -->
        <van-dialog v-model="showBackPop" title="" show-cancel-button :before-close="backPop">
            <div class="popTitle">
                <p>退回</p>
            </div>
            <van-radio-group>
                <van-row class="disposeRow">
                    <van-col span="8" style="text-align:right;font-size:0.85rem;">
                        退回原因:
                    </van-col>
                    <van-col span="14"></van-col>
                </van-row>
                <van-row class="disposeRow">
                    <van-col span="24">
                        <van-field class="applyCause" v-model="Annotation" border='true' rows="3" type="textarea" maxlength="100" placeholder="请填写退回原因" show-word-limit />
                    </van-col>
                </van-row>
            </van-radio-group>
        </van-dialog>
        <!-- 退回备注弹窗 -->

        <div id="main" class="aui-content ">
            <div class="audio-popup" v-if='showAudio' @click='closeAudio'>
                <p>长按录音<br>松开保存</p>
                <div class="audio-time-div"><span>{{AudioTime}}</span>秒</div>
                <img @touchstart='startAudioFnc()' @touchend='stopAudioFnc()' class='audio-img' src="../image/MeterManage/audio.png" alt="">
            </div>
            <div class="content ">
                <div class="row">
                    <div class="text-left">
                        <!-- 任务类型: -->
                        <span class="text-left-title">任务类型</span>:
                    </div>
                    <div class="text-right">
                        <span>{{projectName}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">
                        <!-- 户名: -->
                        <span class="text-left-title">户名</span>:
                    </div>
                    <div class="text-right cause">
                        <span>{{CustomerName}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">

                        <span class="text-left-title">户号</span>:
                    </div>
                    <div class="text-right">
                        <span>{{CustomerCode}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">

                        <span class="text-left-title">地址</span>:
                    </div>
                    <div class="text-right cause">
                        <span>{{Address}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">

                        <span class="text-left-title">表位</span>:
                    </div>
                    <div class="text-right cause">
                        <span>{{tableLocation}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">

                        <span class="text-left-title">表号</span>:
                    </div>
                    <div class="text-right">
                        <span>{{tableCode}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="text-left">

                        <span class="text-left-title">口径</span>:
                    </div>
                    <div class="text-right">
                        <span>{{Caliber}}</span>
                    </div>
                </div>

                <div class="row">
                    <div class="text-left">
                      <span class="text-left-title">申请位置</span>:
                    </div>
                    <div class="text-right">
                        <span @click="openMap" class="textColor">{{AppAddress}}</span>
                    </div>
                </div>

                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">申请原因</span>:
                    </div>
                    <div class="text-right cause">
                        <span>{{Description}}</span>
                    </div>
                </div>
                <!--上一级节点备注信息  -->
                <div class="row">
                    <div class="text-left">
                        <span class="text-left-title">备注</span>:
                    </div>
                    <div class="text-right cause">
                        <span>{{SurveyRemark}}</span>
                    </div>
                </div>
                <div class="row" v-if="isAuditFailed">
                    <div class="text-left">
                        <span class="text-left-title">审核结果</span>:
                    </div>
                    <div class="text-right cause">
                        <span>{{AuditFailed}}</span>
                    </div>
                </div>
                <div class="row" v-show='ygt || hb || sl' >
                    <div class="text-left a-text-left" @click=" if(applyPic.length>0){pBrowserPicture(0,applyPic)}else {vant.Toast('暂无申请图片!');}  ">
                        申请照片
                    </div>
                </div>


                <!-- 移改提 -->
                <div class="" v-if="ygt">
                    <div class="row">
                        <div class="text-left">
                            <span class="text-left-title">抄表员</span>:
                        </div>
                        <div class="text-right">
                            <span>{{ygtObj.MeterReader}}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="text-left">
                            <span class="text-left-title">抄表员电话</span>:
                        </div>
                        <div class="text-right">
                            <span @click="callPhone(ygtObj.MeterReaderPhone)">{{ygtObj.MeterReaderPhone}}</span>
                        </div>
                    </div>
                    <div class="row not_border_bottom">
                        <div class="text-left">
                            <span class="text-left-title">办理情况</span>:
                        </div>
                        <div class="text-right textColor textRight">
                        </div>
                        <div class="textarea" style="margin-bottom: 8px;">
                            <textarea name="name" rows="16" cols="80" v-model="ygtObj.Remark" :readonly="isClaim"></textarea>
                        </div>
                    </div>
                    <div class="row not_border_bottom">
                        <div class="text-left">
                            照片
                        </div>
                        <div class="text-right images">
                            <img @click="openCamera" class="ri" src="../image/MeterManage/paizhao.png" alt="">
                        </div>
                        <div class="photoList">
                            <div class="phont" v-for="(item,index) in pic" :key="index">
                              <i class="delectImg" @click="delectPic(index)"></i>
                              <img :src="item" alt="" @click="pBrowserPicture(index,pic)">
                            </div>
                        </div>
                    </div>
                    <div class="row not_border_bottom" style="border-bottom: none;">
                      <p @click='getLocation'>
                          <i class="addressIcon"></i>
                          <span class="textColor">{{Location}}</span>
                      </p>
                    </div>
                </div>
                <!-- 移改提 -->

                <!-- 换表 -->
                <div class="" v-if="hb">
                    <div class="row">
                        <div class="text-left">
                            <span class="text-left-title">用户电话</span>:
                        </div>
                        <div class="text-right">
                            <span @click="callPhone(hbObj.UserPhone)">{{hbObj.UserPhone}}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="text-left">
                            <span class="text-left-title">抄表员</span>:
                        </div>
                        <div class="text-right">
                            <span>{{hbObj.MeterReader}}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="text-left">
                            <span class="text-left-title">抄表员电话</span>:
                        </div>
                        <div class="text-right">
                            <span @click="callPhone(hbObj.MeterReaderPhone)">{{hbObj.MeterReaderPhone}}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="text-left textColor" @click="openTableMessage">
                            <span class="text-left-title">换表信息</span>
                        </div>
                        <div class="text-right">
                            <span></span>
                        </div>
                    </div>
                    <div class="row not_border_bottom">
                        <div class="text-left">
                            <span class="text-left-title">办理情况</span>:
                        </div>
                        <div class="text-right textColor textRight ">
                        </div>
                        <div class="textarea" style="margin-bottom: 8px;">
                            <textarea name="name" rows="32" cols="80" v-model="hbObj.Remark" :readonly="isClaim"></textarea>
                        </div>
                    </div>
                    <div class="row not_border_bottom">
                        <div class="text-left">
                            照片
                        </div>
                        <div class="text-right images">
                            <img @click="openCamera" class="ri" src="../image/MeterManage/paizhao.png" alt="">
                        </div>
                        <div class="photoList">
                            <div class="phont" v-for="(item,index) in pic" :key="index">
                              <i class="delectImg" @click="delectPic(index)"></i>
                              <img :src="item" alt="" @click="pBrowserPicture(index,pic)">
                            </div>
                        </div>

                    </div>
                    <div class="row not_border_bottom" style="border-bottom: none;">
                      <p @click='getLocation'>
                          <i class="addressIcon"></i>
                          <span class="textColor">{{Location}}</span>
                      </p>
                    </div>
                </div>
                <!-- 换表 -->

                <!-- 校表 -->
                <div class="" v-if="xb">
                    <div class="row not_border_bottom">
                        <div class="text-left">
                            <span class="text-left-title">办理情况</span>:
                        </div>
                        <div class="text-right textColor textRight">
                        </div>
                        <div class="textarea" style="margin-bottom: 8px;">
                            <textarea name="name" rows="16" cols="80" v-model="xbObj.Remark" :readonly="isClaim"></textarea>
                        </div>
                    </div>

                    <div class="row not_border_bottom">
                        <div class="text-left">
                            照片
                        </div>
                        <div class="text-right images">
                            <img @click="openCamera" class="ri" src="../image/MeterManage/paizhao.png" alt="">
                        </div>
                        <div class="photoList">
                            <div class="phont" v-for="(item,index) in pic" :key="index">
                              <i class="delectImg" @click="delectPic(index)"></i>
                              <img :src="item" alt="" @click="pBrowserPicture(index,pic)">
                            </div>
                        </div>

                    </div>
                    <div class="row" style="border-bottom: none;">
                      <p @click='getLocation'>
                          <i class="addressIcon"></i>
                          <span class="textColor">{{Location}}</span>
                      </p>
                    </div>
                </div>
                <!-- 校表 -->

                <!-- 三来 -->
                <div class="" v-if="sl">
                    <div class="slMessage">
                        <div class="row">
                            <div class="text-left">

                                <span class="text-left-title">反映区名</span>:
                            </div>
                            <div class="text-right">
                                <span>{{slObj.AreasName}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="text-left">

                                <span class="text-left-title">客户电话</span>:
                            </div>
                            <div class="text-right">
                                <span>{{slObj.Phone}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="text-left">

                                <span class="text-left-title">信息来源</span>:
                            </div>
                            <div class="text-right">
                                <span>{{slObj.SourceName}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="text-left">

                                <span class="text-left-title">紧急情况</span>:
                            </div>
                            <div class="text-right">
                                <span>{{slObj.UsgentText}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="text-left">

                                <span class="text-left-title">完成时限</span>:
                            </div>
                            <div class="text-right">
                                <span>{{slObj.Processinglevel}} /天</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="text-left">

                                <span class="text-left-title">完成时间</span>:
                            </div>
                            <div class="text-right">
                                <span>{{slObj.EndTime}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="text-left textColor" @click="isOpenPostpone">

                                <span class="text-left-title">申请延期</span>
                            </div>
                            <div class="text-right">
                                <span></span>
                            </div>
                        </div>
                    </div>
                    <div class="row not_border_bottom">
                        <div class="text-left">
                            <span class="text-left-title">办理情况</span>:
                        </div>
                        <div class="text-right textColor textRight">
                            <span @click="isOpenAddResults">添加结果</span>
                        </div>
                        <div class="textarea" style="margin-bottom: 8px;">
                            <textarea name="name" rows="16" cols="80" v-model="resultText" :readonly="isClaim"></textarea>
                        </div>
                    </div>
                    <div class="row not_border_bottom">
                        <div class="text-left">
                            照片
                        </div>
                        <div class="text-right images">
                            <img @click="openCamera" class="ri" src="../image/MeterManage/paizhao.png" alt="">
                        </div>
                        <div class="photoList">
                            <div class="phont" v-for="(item,index) in pic" :key="index">
                                <i class="delectImg" @click="delectPic(index)"></i>
                                <img :src="item" alt="" @click="pBrowserPicture(index,pic)">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                      <!-- 附件 -->
                      <div class="text-left">
                          附件
                      </div>
                      <div class="text-right images" @click="openFile">
                          <img class="ri" src="../image/MeterManage/fujian.png" alt="">
                      </div>
                      <div class="photoList">
                          <div class="fj-item video-div" @click='playVideo' v-if='showVideoDiv'>
                              <div class="" style="width: 100%; height: 2.9rem; position: relative;">
                                  <img src='../image/MeterManage/shanchu.png' class='img-delete' style='width: 16px; height: 16px;' @click='DeleteVideo' />
                                  <img src="../image/MeterManage/video.png" style="width: 50%;position: absolute; top: 50%; left: 50%;margin-top: -15%;margin-left:-25%;" alt="" />
                              </div>
                              视频文件
                          </div>
                          <div class="fj-item audio-div" @click='playAudio' v-if='showAudioDiv'>
                              <div class="" style="width: 100%; height: 2.9rem; position: relative;">
                                  <img src='../image/MeterManage/shanchu.png' class='img-delete' style='width: 16px; height: 16px;' @click='DeleteAudio' />
                                  <img src="../image/MeterManage/audio.png" style="width: 25%;position: absolute; top: 50%; left: 50%;margin-top: -15%;margin-left:-12.5%;" alt="" />
                              </div>
                              音频文件
                          </div>
                      </div>
                    </div>
                    <div class="row" style='border-bottom: none;'>
                      <p @click='getLocation'>
                          <i class="addressIcon"></i>
                          <span class="textColor">{{Location}}</span>
                      </p>
                    </div>
                </div>
                <!-- 三来 -->

            </div>

        </div>

        <div class="footer" v-show="isDispose">
            <van-button round block color="#FFA836" class="showTurnBtn" @click="turnToUser">
                转办
            </van-button>
            <van-button round block type="danger" :disabled="isSubmit" class="showTurnBtn" @click="saveBtnFunc">
                提交
            </van-button>
        </div>
        <div class="footer" v-show="isClaim">
            <van-button round block type="info" class="showTurnBtn" @click="showBackPop = true">
                退回
            </van-button>
            <van-button round block type="danger" class="showTurnBtn" @click="claimFunc">
                认领
            </van-button>
        </div>

    </div>

</body>
<script type="text/javascript" src="../../public/script/api.js"></script>
<script type="text/javascript" src="../../public/script/common.js"></script>
<script type="text/javascript" src="../../public/script/remote.js"></script>
<script type="text/javascript" src="../../public/script/publicMethod.js"></script>
<script type="text/javascript" src="../../public/script/vue/fastclick.min.js"></script>
<script type="text/javascript" src="../../public/script/vue/vue.min.js"></script>
<script type="text/javascript" src="../../public/script/vue/vant.min.js"></script>
<script type="text/javascript" src="../../public/script/vue/vueTouch.js"></script>
<script type="text/javascript" src="../../public/script/moment.js"></script>
<script type="text/javascript" src="../script/remote.js"></script>
<script type="text/javascript" src="../script/meterManageLocalData.js"></script>
<script type="text/javascript" src="./js/auidialog.js"></script>
<script type="text/javascript" src="../../public/script/diy/public.js"></script>
<script type="text/javascript">
    apiready = function() {
        dataObj = api.pageParam.data,
            getTaskType = api.pageParam.type;
        isClaim = false;
        isDispose = false;
        if (getTaskType == 'claimTask') { //认领详情
            isClaim = true;
            isDispose = false;
        } else if (getTaskType == 'handle') { //任务处理
            isClaim = false;
            isDispose = true;
        }

        //home键监听
        api.addEventListener({
            name: 'keyback'
        }, function(ret, err) {
            if (getTaskType == 'handle') { //任务处理 返回事件
                api.sendEvent({
                    name: 'refreshCloudMyTask',
                    extra: {
                        type: '1'
                    }
                });
            } else if (getTaskType == 'claimTask') { //任务领用 返回事件
                api.sendEvent({
                    name: 'refreshCloudClaim',
                    extra: {
                        type: '1'
                    }
                });
            }
            api.closeWin();
        });

        //3换表 13移改提 14校表 15三来工单 16其他工单 停水通知单4 通水任务42 通水任务(先通水)41 停水办理2 ServiceTypeId
        var header = $api.byId('header');
        $api.fixStatusBar(header);
        $api.fixIos7Bar(header);

        bMap = api.require("bMap");
        db = api.require("db");

        messageObj = {
            'dataObj': {
                'BeginScale': '',
                'LastReadScale': '',
                'OriginalScale': '',
                'OldAmount': '',
                'StampNo': '',
                'ActualTableCode': '',
                'ComputeType': '',
                'ComputeTypeId': '',
                'Caliber': '',
                'CaliberId': '',
                'MeterType': '',
                'MeterTypeId': '',
                'NamePlate': '',
                'NamePlateId': '',
                'SealNo': '',
                'Zhf': '',
                'Jyf': '',
                'Model': '',
                'ModelId': '',
                'InstallationMode': '',
                'InstallationModeId': '',
            }
        };
        api.addEventListener({
            name: 'hbMessage'
        }, (ret, err) => {
            console.log(JSON.stringify(ret));
            messageObj = ret.value;
        });

        fnIntVue();
        Origami.fastclick(document.body) //消除vue的ios端点击延迟

    };
    // fnIntVue();
    function fnIntVue() {
        window.ApplyTaskVue = new Vue({
            el: '#wrap',
            data: {
                currentDate: new Date(),
                datePicker: '',
                minTime: new Date(),
                showDate: false,
                dataObj: dataObj,
                isClaim: isClaim,
                isDispose: isDispose,
                projectName: '',
                // Id:dataObj.id,
                hb: false,
                ygt: false,
                xb: false,
                sl: false,
                // trunBtnIf:trunBtnIf,

                showRemark: false,
                cause: false,

                Annotation: '', //退回备注
                showAreaSelect: false,
                showResultSelect: false,
                showPicker: false,
                showTimePicker: false,
                showBackPop: false, //退回备注弹窗是否展示
                Annotation: '', //退回原因
                cutWater: [],
                addResult: [{
                    name: "按期完成",
                    id: 1
                }, {
                    name: "客户取消",
                    id: 2
                }, {
                    name: "上门不遇",
                    id: 3
                }, {
                    name: "线上完成",
                    id: 4
                }],

                resultText: "",
                resultTextId: 0,
                dayHourRadio: 1, // 1-天  2-小时
                dayHourVal: '',
                dayHourText: '',

                DispatchTime: '', //分派时间
                CustomerCode: '', //户号
                CustomerName: '', //户名
                Address: '', //用户地址
                tableLocation: '', //水表位置
                tableCode: '', //表号
                Nature: '', //用水性质
                Caliber: '', //口径
                SurveyRemark: '', //上一节点备注 zxf 6-8

                AppAddress: '', //申请任务时位置
                ApplyLon: '', //申请任务时纬度
                ApplyLat: '', //申请任务时纬度

                pic: [], //图片
                fileArray: [{
                    'fileName': '',
                    'fileUrl': ''
                }], //附件

                Description: '', //申请原因

                hbObj: {
                    Description: '', //申请原因
                    EndScale: '', //旧表止度
                    StampNo: '', //新表表号
                    Nameplate: '', //水表铭牌
                    BeginScale: '', //新表起度
                    Caliber: '', //新表口径
                    Remark: '', //备注
                    UserPhone: '', //用户电话
                    MeterReader: '', //抄表员
                    MeterReaderPhone: '', //抄表员电话
                    // messageObj:{},
                },
                ygtObj: {
                    Description: '', //申请原因
                    Remark: '', //备注
                    MeterReader: '', //抄表员
                    MeterReaderPhone: '', //抄表员电话
                    // pic:'',//图片
                },
                xbObj: {
                    Description: '', //原因
                    Remark: '', //备注
                    // pic:'',//照片
                },
                slObj: {
                    problemDescription: '', //问题描述
                    postponeNum: { //延期次数
                        num: 0,
                        postponeArray: [],
                    },
                    OrderNo: '', //工单
                    AreasName: '', //反映区名
                    SourceName: '', //信息来源
                    UsgentText: '', //紧急情况
                    Processinglevel: '', //处理级别
                    Phone: '', //联系电话
                    EndTime: '', //完成时间
                    disResult: '', //处理结果
                    // pic:[],//处理照片
                    Address: '', //地址
                },

                // TaskData:{},

                Longitude: 0,
                Latitude: 0,
                Location: "",
                audioPath: '',
                videoPath: '',

                show: true,
                index: 0,
                userInfoMationObj: {},

                taskInfoData: {}, //任务详情信息

                isAuditFailed: false, //审核失败
                AuditFailed: '', //审核失败原因

                showAudio: false, //录音
                AudioTime: 0, //录音时长

                showVideoDiv: false, //显示视频
                showAudioDiv: false, //显示音频

                isSubmit: false, //优化提交点击

                isUploadFile: $api.getStorage('meterManageUploadPicture'), //是否单独上传数据及照片
                applyPic: [], //申请任务时候的图片  zxf 20200619
                isApplyPic:true

            },
            computed: {

            },
            methods: {
                isOpenPostpone() { //是否可以打开延期弹窗
                    if (this.isClaim) {
                        return
                    }
                    this.showTimePicker = true;
                },
                isOpenAddResults() {
                    if (this.isClaim) {
                        return
                    }
                    this.showPicker = true;
                    this.showResultSelect = true;
                },
                openTableMessage() { //打开换表信息
                    if (this.isClaim) {
                        return
                    }
                    api.openWin({
                        name: 'tableMessage',
                        url: './tableMessage.html',
                        pageParam: {
                            messageObj: messageObj,
                            taskInfoData: this.taskInfoData
                        }
                    });
                },
                getDetail() { //获取详情信息
                    if (api.connectionType == 'none') {
                        //无网络 -- 查询本地数据
                        this.selectLocalData();
                    } else {
                        //有网络
                        //3换表 13移改提 14校表 15三来工单 16其他工单 停水通知单4 通水任务42 通水任务(先通水)41 停水办理2
                        var body = {
                            'ReqCode': this.dataObj.taskCode, //流程编号
                            'TypeId': 1
                        };
                        fngetmmsPost('MMS104', body, 'application/json', true, false, (ret, err) => {
                            api.hideProgress();
                            if (ret && ret.Status == 0) {
                                var data = JSON.parse(ret.Data); // dataObj
                                this.taskInfoData = JSON.parse(ret.Data)[0];
                                console.log(JSON.stringify(this.taskInfoData.Files))
                                this.queryReviewData();
                                // this.showDetailVal(data);
                            } else {
                                this.selectLocalData();
                            }
                        });
                    }
                },
                showDetailVal(data) { //取详情返回的数据赋值
                    this.dataObj.ServiceTypeId = data[0].ServiceTypeId; //任务类型
                    this.dataObj.CustomerCode = data[0].CustomerCode; //户号
                    this.dataObj.ActivityCode = data[0].ActivityCode;

                    this.projectName = data[0].TypeName;

                    if (data[0].ServiceTypeId == 3) {
                        this.hb = true;
                    } else if (data[0].ServiceTypeId == 13) {
                        this.ygt = true;
                    } else if (data[0].ServiceTypeId == 14) { //校表
                        if (data[0].ActivityCode == '11') { //节点Id为11是换表处理
                            this.hb = true;
                        } else if (data[0].ActivityCode == '03') { //节点Id为03是校表处理
                            this.xb = true;
                        }
                    } else if (data[0].ServiceTypeId == 15 || data[0].ServiceTypeId == 16 || data[0].ServiceTypeId == 17) {
                        this.sl = true;
                    }

                    this.userInfoMationObj = data[0];
                    this.dataObj.WorkflowId = data[0].WorkflowId; //流程ID
                    this.dataObj.ActivityId = data[0].ActivityId; //节点ID
                    this.dataObj.StepId = data[0].StepId; //指向ID

                    this.CustomerCode = data[0].CustomerCode; //户号
                    this.CustomerName = data[0].CustomerName; //户名
                    this.Address = data[0].Address; //用户地址
                    this.tableLocation = data[0].Location; //水表位置
                    this.tableCode = data[0].StampNo; //水表表号
                    this.Nature = data[0].NatureName; //用水性质
                    this.Caliber = data[0].Caliber; //口径
                    this.SurveyRemark = data[0].SurveyRemark!="undefined"?data[0].SurveyRemark:''; // 上一节点备注信息 zxf 6-8  0709修改添加undefined判断
                    this.AppAddress = data[0].AppAddress;
                    var fieldFive = data[0].fieldFive.split(",");
                    this.ApplyLon = fieldFive[0];
                    this.ApplyLat = fieldFive[1];

                    if (JSON.parse(data[0].Budgetaudit).length > 0) {
                        this.isAuditFailed = true;
                        this.AuditFailed = JSON.parse(data[0].Budgetaudit)[0].Content;
                    }
                    if(this.isApplyPic){ //申请图片
                      if (data[0].Files != '' &&  data[0].Files != null &&  data[0].Files != 'null') {
                          var files = JSON.parse(data[0].Files);
                          files.forEach((item, index) => {
                              if (item.AttachmentType == 1) {
                                this.applyPic.push("http://" + $api.getStorage('apiUrl') + item.Path);
                              }
                          });
                      }
                    }

                    // if (data[0].Path) {
                    //     var imgList = data[0].Path.split(",");
                    //     for (var i = 0; i < imgList.length; i++) {
                    //       this.pic.push(imgList[i]);
                    //     }
                    // }

                    if (data[0].MeterRemark != '' && data[0].Remark != 'null' && data[0].Remark != '') {
                        this.Description = data[0].MeterRemark + ',' + data[0].Remark;
                    } else if (data[0].MeterRemark != '') {
                        this.Description = data[0].MeterRemark;
                    } else if (data[0].Remark != 'null' && data[0].Remark != '') {
                        this.Description = data[0].Remark;
                    }

                    if (this.hb) {
                        this.hbObj.Description = data[0].Description == null ? '' : data[0].Description; //申请原因
                        this.hbObj.EndScale = data[0].EndScale; //旧表止度
                        this.hbObj.StampNo = data[0].StampNo; //新表表号
                        this.hbObj.Nameplate = data[0].Nameplate; //水表铭牌
                        this.hbObj.BeginScale = data[0].BeginScale; //新表起度
                        this.hbObj.Caliber = data[0].Caliber; //新表口径

                        this.hbObj.UserPhone = data[0].Phone; //用户电话
                        this.hbObj.MeterReader = data[0].fieldOne; //抄表员
                        this.hbObj.MeterReaderPhone = data[0].fieldTwo; //抄表员电话
                    }

                    if (this.ygt) {
                        this.ygtObj.Description = data[0].MeterRemark == 'null' ? '' : data[0].MeterRemark; //申请原因
                        this.ygtObj.MeterReader = data[0].fieldOne; //抄表员
                        this.ygtObj.MeterReaderPhone = data[0].fieldTwo; //抄表员电话
                    }

                    if (this.xb) {}
                    if (this.sl) {
                        this.slObj.OrderNo = data[0].OrderNo, //工单
                            this.slObj.AreasName = data[0].AreasName, //反映区名
                            this.slObj.SourceName = data[0].SourceName; //信息来源
                        this.slObj.UsgentText = data[0].UsgentText; //紧急情况
                        this.slObj.Processinglevel = data[0].Processinglevelid; //处理级别
                        this.slObj.Phone = data[0].Phone; //联系电话
                        this.slObj.EndTime = data[0].EndTime; //完成时间
                        if (data[0].EndTime != '' || data[0].EndTime.length > 0) {
                            this.minTime = new Date(data[0].EndTime);
                            this.currentDate = new Date(data[0].EndTime);
                        }
                        this.slObj.Address = data[0].Address; //地址
                    }

                    var _that = this;
                    db.selectSql({
                        name: 'Wsdatabase',
                        sql: "SELECT * FROM Review_TASK_HANDLED_LIST WHERE ReqCode = '" + this.dataObj.taskCode + "'"
                    }, function(ret, err) {
                        if (ret.status) {
                            console.log(JSON.stringify(ret));
                            var saveData = ret.data[0];
                            if (ret.data.length > 0) {
                                var imgArr = saveData.filePath.split("|");
                                if (imgArr.length > _that.pic.length) {
                                  for (var i = 0; i < imgArr.length; i++) {
                                      var imgType = imgArr[i].substring(imgArr[i].lastIndexOf("."));
                                      if (imgType == ".jpg" || imgType == ".png") {
                                          _that.pic.push(imgArr[i]);
                                      }
                                  }
                                }
                                _that.Longitude = saveData.Longitude;
                                _that.Latitude = saveData.Latitude;
                                _that.Location = saveData.Location;

                                if (_that.hb) {
                                    _that.hbObj.Remark = saveData.Remark;
                                    //换表信息
                                    messageObj.dataObj.BeginScale = saveData.LastReadScale;
                                    messageObj.dataObj.LastReadScale = saveData.BeginScale;
                                    messageObj.dataObj.OriginalScale = saveData.OriginalScale;
                                    messageObj.dataObj.OldAmount = saveData.OldAmount;
                                    messageObj.dataObj.StampNo = saveData.StampNo;
                                    messageObj.dataObj.ActualTableCode = saveData.ConcreteScale;
                                    messageObj.dataObj.ComputeTypeId = saveData.ComputeTypeId;
                                    messageObj.dataObj.CaliberId = saveData.Caliber;
                                    messageObj.dataObj.MeterTypeId = saveData.MeterTypeId;
                                    messageObj.dataObj.NamePlateId = saveData.NamePlateId;
                                    messageObj.dataObj.SealNo = '';
                                    messageObj.dataObj.Zhf = '';
                                    messageObj.dataObj.Jyf = '';
                                    messageObj.dataObj.ModelId = saveData.ModelId;
                                    messageObj.dataObj.InstallationModeId = saveData.InstallationModeId;
                                } else if (_that.ygt) {
                                    _that.ygtObj.Remark = saveData.Remark;
                                } else if (_that.xb) {
                                    _that.xbObj.Remark = saveData.Remark;
                                } else if (_that.sl) {
                                    _that.resultText = saveData.Remark;
                                    _that.audioPath = saveData.audioPath;
                                    _that.videoPath = saveData.videoPath;
                                    if (_that.videoPath != '') {
                                        _that.showVideoDiv = true;
                                    }
                                    if (_that.audioPath != '') {
                                        _that.showAudioDiv = true;
                                    }
                                }
                            }
                        } else {
                            console.log(JSON.stringify(err));
                        }
                    });
                },
                saveBtnFunc() { //点击提交
                    this.isSubmit = true;
                    var ServiceTypeId = this.dataObj.ServiceTypeId;
                    //3换表 13移改提 14校表 15三来工单 16其他工单 停水通知单4 通水任务42 通水任务(先通水)41 停水办理2
                    if (this.pic.length == 0 || this.pic == []) {
                        api.toast({
                            msg: '请上传照片',
                            duration: 2000,
                            location: 'bottom'
                        });
                        this.isSubmit = false;
                        return
                    }

                    var body = {};
                    var MethodType = 'MMS105';
                    if (ServiceTypeId == 13) { //移改提
                        body = {
                            'Longitude': JSON.stringify(this.Longitude), //经度
                            'Latitude': JSON.stringify(this.Latitude), //纬度
                            'Location': JSON.stringify(this.Location), //定位地址
                            'ReqCode': this.dataObj.taskCode, //流程Code
                            'WorkflowId': this.dataObj.WorkflowId, //流程Id
                            'ActivityId': this.dataObj.ActivityId, //节点Id
                            'StepId': this.dataObj.StepId, //指向Id
                            'TypeId': ServiceTypeId, //流程类型
                            'CustomerCode': this.CustomerCode, //用户编号
                            'ClientId': api.deviceId, //手机MEI
                            'deviceName': api.deviceName, //手机名称
                            'Remark': this.ygtObj.Remark, //处理结果
                        }
                    } else if (ServiceTypeId == 14) { //校表
                        if (this.dataObj.ActivityCode == '11') { //节点Id为11是换表处理
                            if (messageObj == '') {
                                vant.Toast('请完善换表信息');
                                this.isSubmit = false;
                                return;
                            }
                            if (messageObj.dataObj.LastReadScale == '' ||
                                messageObj.dataObj.BeginScale == '' ||
                                messageObj.dataObj.OriginalScale == '' ||
                                messageObj.dataObj.OldAmount == '' ||
                                messageObj.dataObj.StampNo == '' ||
                                messageObj.dataObj.ComputeTypeId == '' ||
                                messageObj.dataObj.CaliberId == '' ||
                                messageObj.dataObj.MeterTypeId == '' ||
                                messageObj.dataObj.NamePlateId == '') {
                                vant.Toast('请完善换表信息');
                                this.isSubmit = false;
                                return;
                            }

                            body = {
                                'ReqCode': this.dataObj.taskCode, //流程编号
                                'CustomerCode': this.CustomerCode, //用户编号
                                'CauseId': '', //换表原因
                                'Remark': this.hbObj.Remark,
                                'TypeId': ServiceTypeId, //流程类型
                                'ClientId': api.deviceId, //手机MEI
                                'ClientName': api.deviceName, //手机名称
                                'Longitude': this.Longitude, //经度
                                'Latitude': this.Latitude, //纬度
                                'Location': this.Location, //定位地址
                                'BeginScale': messageObj.dataObj.LastReadScale, //旧表止度
                                'LastReadScale': messageObj.dataObj.BeginScale, //旧表随后抄表止度
                                'OriginalScale': messageObj.dataObj.OriginalScale, //新表起度
                                'OldAmount': messageObj.dataObj.OldAmount, //换表水量
                                'StampNo': messageObj.dataObj.StampNo, //水表表号
                                'ComputeTypeId': messageObj.dataObj.ComputeTypeId, //计费时间即换表水量计算方式
                                'Caliber': messageObj.dataObj.CaliberId, //水表口径
                                'MeterTypeId': messageObj.dataObj.MeterTypeId, //水表类型
                                'NamePlateId': messageObj.dataObj.NamePlateId, //水表铭牌
                                'SealNo': messageObj.dataObj.SealNo, //水表铅封号
                                'Zhf': messageObj.dataObj.Zhf, //止回阀
                                'Jyf': messageObj.dataObj.Jyf, //减压阀
                                'ModelId': messageObj.dataObj.ModelId == '' ? "" : messageObj.dataObj.ModelId, //水表型号
                                'InstallationModeId': messageObj.dataObj.InstallationModeId == '' ? '' : messageObj.dataObj.InstallationModeId, //安装方式
                                'WorkflowId': this.dataObj.WorkflowId, //流程Id
                                'ActivityId': this.dataObj.ActivityId, //节点Id
                                'StepId': this.dataObj.StepId, //指向Id
                                'ConcreteScale': messageObj.dataObj.ActualTableCode, //实际表码
                            };
                            MethodType = 'MMS106';
                        } else if (this.dataObj.ActivityCode == '03') { //节点Id为03是校表处理
                            body = {
                                'Longitude': this.Longitude, //经度
                                'Latitude': this.Latitude, //纬度
                                'Location': this.Location, //定位地址
                                'ReqCode': this.dataObj.taskCode, //流程Code
                                'WorkflowId': this.dataObj.WorkflowId, //流程Id
                                'ActivityId': this.dataObj.ActivityId, //节点Id
                                'StepId': this.dataObj.StepId, //指向Id
                                'TypeId': ServiceTypeId, //流程类型
                                'CustomerCode': this.CustomerCode, //用户编号
                                'Remark': this.xbObj.Remark, //处理结果
                                'ClientId': api.deviceId, //手机MEI
                                'deviceName': api.deviceName, //手机名称
                            };
                        }
                    } else if (ServiceTypeId == 15 || ServiceTypeId == 16 || ServiceTypeId == 17) { //三来工单
                        body = {
                            'Longitude': this.Longitude, //经度
                            'Latitude': this.Latitude, //纬度
                            'Location': this.Location, //定位地址
                            'ReqCode': this.dataObj.taskCode, //流程Code
                            'WorkflowId': this.dataObj.WorkflowId, //流程Id
                            'ActivityId': this.dataObj.ActivityId, //节点Id
                            'StepId': this.dataObj.StepId, //指向Id
                            'TypeId': ServiceTypeId, //流程类型
                            'CustomerCode': this.CustomerCode, //用户编号
                            'Remark': this.resultText, //备注
                            'ClientId': api.deviceId, //手机MEI
                            'deviceName': api.deviceName, //手机名称
                        };
                    } else if (ServiceTypeId == 3) { //换表
                        if (messageObj == '') {
                            vant.Toast('请完善换表信息');
                            this.isSubmit = false;
                            return;
                        }
                        if (messageObj.dataObj.LastReadScale == '' ||
                            messageObj.dataObj.BeginScale == '' ||
                            messageObj.dataObj.OriginalScale == '' ||
                            messageObj.dataObj.OldAmount == '' ||
                            messageObj.dataObj.StampNo == '' ||
                            messageObj.dataObj.ComputeTypeId == '' ||
                            messageObj.dataObj.CaliberId == '' ||
                            messageObj.dataObj.MeterTypeId == '' ||
                            messageObj.dataObj.NamePlateId == '') {
                            vant.Toast('请完善换表信息');
                            this.isSubmit = false;
                            return;
                        }

                        body = {
                            'ReqCode': this.dataObj.taskCode, //流程编号
                            'CustomerCode': this.CustomerCode, //用户编号
                            'CauseId': '', //换表原因
                            'Remark': this.hbObj.Remark,
                            'TypeId': ServiceTypeId, //流程类型
                            'ClientId': api.deviceId, //手机MEI
                            'ClientName': api.deviceName, //手机名称
                            'Longitude': this.Longitude, //经度
                            'Latitude': this.Latitude, //纬度
                            'Location': this.Location, //定位地址
                            'BeginScale': messageObj.dataObj.LastReadScale, //旧表止度
                            'LastReadScale': messageObj.dataObj.BeginScale, //旧表随后抄表止度
                            'OriginalScale': messageObj.dataObj.OriginalScale, //新表起度
                            'OldAmount': messageObj.dataObj.OldAmount, //换表水量
                            'StampNo': messageObj.dataObj.StampNo, //水表表号
                            'ComputeTypeId': messageObj.dataObj.ComputeTypeId, //计费时间即换表水量计算方式
                            'Caliber': messageObj.dataObj.CaliberId, //水表口径
                            'MeterTypeId': messageObj.dataObj.MeterTypeId, //水表类型
                            'NamePlateId': messageObj.dataObj.NamePlateId, //水表铭牌
                            'SealNo': messageObj.dataObj.SealNo, //水表铅封号
                            'Zhf': messageObj.dataObj.Zhf, //止回阀
                            'Jyf': messageObj.dataObj.Jyf, //减压阀
                            'ModelId': messageObj.dataObj.ModelId == '' ? "" : messageObj.dataObj.ModelId, //水表型号
                            'InstallationModeId': messageObj.dataObj.InstallationModeId == '' ? '' : messageObj.dataObj.InstallationModeId, //安装方式
                            'WorkflowId': this.dataObj.WorkflowId, //流程Id
                            'ActivityId': this.dataObj.ActivityId, //节点Id
                            'StepId': this.dataObj.StepId, //指向Id
                            'ConcreteScale': messageObj.dataObj.ActualTableCode, //实际表码
                        };
                        MethodType = 'MMS106';
                    }
                    this.filesHandledFnc(MethodType, body); //图片上传成功后，再提交任务处理
                },
                filesHandledFnc(MethodType, body) { //文件处理
                    var imgList = this.pic; //选择图标
                    var fileTypeId = ''; //文件后缀
                    var filePath = '';
                    var uploadFiles = [];
                    for (var i = 0, len = imgList.length; i < len; i++) {
                        fileTypeId += imgList[i].substr(imgList[i].lastIndexOf(".") + 1) + "|";
                        filePath += imgList[i] + "|";
                        uploadFiles.push(imgList[i]);
                    }

                    if (this.audioPath != '') {
                        uploadFiles.push(this.audioPath);
                        fileTypeId += this.audioPath.substr(this.audioPath.lastIndexOf(".") + 1) + "|";
                        filePath += this.audioPath + "|";
                    }

                    if (this.videoPath != '') {
                        uploadFiles.push(this.videoPath);
                        fileTypeId += this.videoPath.substr(this.videoPath.lastIndexOf(".") + 1) + "|";
                        filePath += this.videoPath + "|";
                    }

                    if (fileTypeId != '') {
                        fileTypeId = fileTypeId.substring(0, fileTypeId.length - 1);
                    }
                    if (filePath != '') {
                        filePath = filePath.substring(0, filePath.length - 1);
                    }

                    var _that = this;
                    api.showProgress({
                        title: '正在加载',
                        text: '',
                        modal: false
                    });
                    console.log(JSON.stringify(uploadFiles));
                    console.log(fileTypeId);
                    console.log(filePath);

                    if (_that.isUploadFile == 1 || api.connectionType == 'none') {
                        //单独上传数据及照片  或  无网络情况下
                        var saveData = {
                            ReqCode: body.ReqCode,
                            Longitude: _that.Longitude,
                            Latitude: _that.Latitude,
                            Location: _that.Location,
                            Remark: body.Remark,
                            BeginScale: body.BeginScale,
                            LastReadScale: body.LastReadScale,
                            OriginalScale: body.OriginalScale,
                            OldAmount: body.OldAmount,
                            StampNo: body.StampNo,
                            ComputeTypeId: body.ComputeTypeId,
                            Caliber: body.Caliber,
                            MeterTypeId: body.MeterTypeId,
                            NamePlateId: body.NamePlateId,
                            ModelId: body.ModelId,
                            InstallationModeId: body.InstallationModeId,
                            ConcreteScale: body.ConcreteScale,
                            TypeId: fileTypeId,
                            filePath: filePath,
                            audioPath: _that.audioPath,
                            videoPath: _that.videoPath
                        };
                        var msg = '';
                        if (_that.isUploadFile == 1) {
                            msg = "当前设置为：数据及照片单独上传，是否保存至本地？"
                        } else if (api.connectionType == 'none') {
                            msg = "当前无网络，是否保存至本地？"
                        }
                        api.confirm({
                            title: '提示',
                            msg: msg,
                            buttons: ['确定', '取消']
                        }, function(ret, err) {
                            if (ret.buttonIndex == 1) {
                                _that.saveDataLocal(saveData);
                            } else {
                                _that.isSubmit = false;
                                api.hideProgress();
                            }
                        });
                    } else {
                        _that.submitData(MethodType, body, fileTypeId, filePath, uploadFiles);
                    }
                },
                submitData(MethodType, body, fileTypeId, filePath, uploadFiles) {
                    var _that = this;
                    bwfnPostNew(MethodType, body, 'application/json', true, false, (ret, err) => {
                        // api.hideProgress();
                        console.log(JSON.stringify(ret));
                        console.log(JSON.stringify(err));
                        if (ret) {
                            if (ret.Status == 0) {
                                _that.uploadFilesFnc(fileTypeId, filePath, uploadFiles);
                            } else {
                                api.hideProgress();
                                _that.isSubmit = false;
                                api.toast({
                                    msg: ret.Message,
                                    duration: 2000,
                                    location: 'top'
                                });
                            }
                        } else {
                            api.hideProgress();
                            _that.isSubmit = false;
                            api.toast({
                                msg: err.msg,
                                duration: 2000,
                                location: 'top'
                            });
                        }
                    });
                },
                uploadFilesFnc(fileTypeId, filePath, uploadFiles) {
                    var _that = this;
                    console.log("编号：" + _that.dataObj.taskCode);
                    console.log("附件：" + uploadFiles.length);
                    api.ajax({
                        url: $api.getStorage("bwapipath") + '/api/waterMeters/info',
                        method: 'post',
                        timeout: 60,
                        dataType: 'json',
                        returnAll: false,
                        headers: 'application/json',
                        data: {
                            values: {
                                Method: 'MMS100',
                                UserName: $api.getStorage("bwUserName"), //"01012"
                                Password: $api.getStorage("bwPassWord"), // "g6OuZomFp3E="
                                SerialNo: '',
                                KeyCode: '', //营业
                                Parameter: "{'ReqCode':'" + _that.dataObj.taskCode + "', 'TypeId':'" + fileTypeId + "', 'filePath':'" + filePath + "', 'AttachmentType': '4'}"
                            },
                            files: {
                                file: uploadFiles
                            }
                        }
                    }, function(ret, err) {
                        api.hideProgress();
                        console.log(uploadFiles.length);
                        console.log(JSON.stringify(ret));
                        _that.isSubmit = false;
                        if (ret && ret.Status == 0) {
                            var retOne = db.executeSqlSync({
                                name: 'Wsdatabase',
                                sql: "UPDATE Review_TASK_BASIC_LIST SET isUploadAndSave = '1' WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                            });
                            console.log(JSON.stringify(retOne));
                            var retTwo = db.executeSqlSync({
                                name: 'Wsdatabase',
                                sql: "UPDATE Review_TASK_HANDLED_LIST SET isUpload = '1' WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                            });
                            console.log(JSON.stringify(retTwo));
                            var deleteRet = db.executeSqlSync({
                                name: 'Wsdatabase',
                                sql: "DELETE FROM myTaskSheet WHERE taskCode='" + _that.dataObj.taskCode + "'"
                            });
                            console.log(JSON.stringify(deleteRet));

                            var fs = api.require("fs");
                            if ($api.getStorage('meterManageSaveLocation') != 1) {
                                for (var i = 0; i < uploadFiles.length; i++) {
                                    fs.remove({
                                        path: uploadFiles[i]
                                    }, function(ret, err) {
                                        if (ret.status) {
                                            console.log(JSON.stringify(ret));
                                        } else {
                                            console.log(JSON.stringify(err));
                                        }
                                    });
                                }
                            }
                            api.toast({
                                msg: '处理成功',
                                duration: 2000,
                                location: 'top'
                            });
                            setTimeout(function() {
                                api.openWin({
                                    name: 'tableTaskDetail',
                                    url: './tableTaskDetail.html',
                                    pageParam: {
                                        'data': _that.dataObj,
                                        'type': getTaskType
                                    }
                                });
                            }, 1000);
                        } else {
                            console.log(JSON.stringify(err));
                            vant.Toast("图片上传失败，已保存至本地");
                            //图片上传失败
                            var saveData = {
                                ReqCode: _that.dataObj.taskCode,
                                Longitude: '',
                                Latitude: '',
                                Location: '',
                                Remark: '',
                                BeginScale: '',
                                LastReadScale: '',
                                OriginalScale: '',
                                OldAmount: '',
                                StampNo: '',
                                ComputeTypeId: '',
                                Caliber: '',
                                MeterTypeId: '',
                                NamePlateId: '',
                                ModelId: '',
                                InstallationModeId: '',
                                ConcreteScale: '',
                                TypeId: fileTypeId,
                                filePath: filePath,
                                audioPath: _that.audioPath,
                                videoPath: _that.videoPath
                            };
                            _that.saveDataLocal(saveData);
                        }
                    });
                },
                backPop(action, done) { //打开退回弹窗
                    if (action == "confirm") {
                        this.sendBack();
                        done();
                    } else if (action == 'cancel') {
                        done();
                    }
                },
                sendBack() { //退回接口请求

                    //移改提、换表，三来工单，校表
                    var obj = {
                        'InstanceId': this.dataObj.WorkflowId, //流程ID
                        'StepId': this.dataObj.StepId, //指向ID
                        'Annotation': this.Annotation, //备注
                    };

                    bwfnPost('MMS109', obj, 'application/json', false, false, (ret, err) => {
                        api.hideProgress();
                        if (ret) {
                            if (ret.Status == 0) {
                                //退回成功 删除该条本地数据
                                db.executeSql({
                                    name: 'Wsdatabase',
                                    sql: "DELETE FROM Review_TASK_BASIC_LIST WHERE ReqCode='" + _that.dataObj.taskCode + "'"
                                }, function(ret, err) {
                                    if (ret.status) {
                                        console.log(JSON.stringify(ret));
                                    } else {
                                        console.log(JSON.stringify(err));
                                    }
                                });
                                //删除云平台本地数据
                                db.executeSql({
                                    name: 'Wsdatabase',
                                    sql: "DELETE FROM myTaskSheet WHERE taskCode='" + _that.dataObj.taskCode + "'"
                                }, function(ret, err) {
                                    if (ret.status) {
                                        console.log(JSON.stringify(ret));
                                    } else {
                                        console.log(JSON.stringify(err));
                                    }
                                });
                                api.toast({
                                    msg: "退回成功",
                                    duration: 2000,
                                    location: 'top'
                                });
                                setTimeout(function() {
                                    api.sendEvent({
                                        name: 'refreshCloudClaim',
                                        extra: {
                                            key1: 'value1',
                                            key2: 'value2'
                                        }
                                    });
                                    api.closeWin();

                                }, 1000);
                            }
                            console.log(JSON.stringify(ret));
                        } else {
                            api.toast({
                                msg: err.msg,
                                duration: 2000,
                                location: 'top'
                            });
                        }
                    });
                },
                turnToUser() { //点击转办
                    api.openWin({
                        name: 'TurnToUser',
                        url: './TurnToUser.html',
                        pageParam: {
                            data: this.dataObj,
                            type: getTaskType
                        }
                    });
                },
                claimFunc() { //认领接口请求
                    pGetLocation((ret, err) => {
                        if (ret.status) {
                            this.Longitude = ret.lon;
                            this.Latitude = ret.lat;
                            var body = {
                                body: JSON.stringify({
                                    taskCode: this.dataObj.taskCode, // 云平台传的id  将id修改taskcode  20200807 14:44 zxf
                                    lng: ret.lon,
                                    lat: ret.lat,
                                    account: $api.getStorage("bwUserName"),
                                    passWord: $api.getStorage("bwPassWord")
                                })
                            };
                            api.ajax({
                                url: 'http://' + $api.getStorage('apiUrl') + '/api/services/app/WorkFlow/ConfirmTaskById',
                                method: 'post',
                                dataType: "json",
                                returnAll: false,
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": $api.getStorage('loginInfo')
                                },
                                data: body
                            }, (ret, err) => {
                                api.hideProgress();
                                if (ret) {
                                    if (ret.success) {
                                      this.isApplyPic = false;
                                        this.queryReviewData();
                                        updateMyTaskSheets(ret.result); //添加数据到云平台我的任务本地数据 2020810 11:08 zxf
                                        api.sendEvent({
                                            name: 'refreshCloudMyTask',
                                        });

                                        api.toast({
                                            msg: '任务认领成功',
                                            duration: 2000,
                                            location: 'middle'
                                        });

                                        this.isClaim = false; //详情
                                        this.isDispose = true; //处理
                                    } else {
                                        api.toast({
                                            msg: ret.Message,
                                            duration: 2000,
                                            location: 'middle'
                                        });
                                    }
                                } else {
                                    api.toast({
                                        msg: err.msg,
                                        duration: 2000,
                                        location: 'middle'
                                    });
                                }
                            });
                        }
                    });

                },
                turnTime(time) {
                    return time.getFullYear() + '-' + (time.getMonth() + 1) + '-' + time.getDate() + ' ' +
                        time.getHours() + ':' + time.getMinutes() + ':' + time.getSeconds();
                },
                openCamera() { //打开相机
                    if (this.isClaim) {
                        return
                    }
                    var _that = this;
                    api.actionSheet({
                        cancelTitle: '取消',
                        buttons: ['拍照', '相册']
                    }, (ret, err) => {
                        var options = {
                            type: 'camera',
                            waterMark: true,
                            // waterMarkNewUrl: api.fsDir + "/picture/",
                            waterMarkData: {
                                code: _that.CustomerCode,
                            }
                        };
                        if (ret.buttonIndex == 1) { //打开相机
                            options.type = 'camera';
                        }
                        if (ret.buttonIndex == 2) {
                            options.type = 'pic';
                        }
                        if (ret.buttonIndex != 3) {
                            pGetPicture(options, function(ret, err) {
                                if (ret.status) {
                                    ret.imgList.forEach(function(item, index) {
                                        if (_that.pic.length < 5) {
                                            _that.pic.push(item);
                                        } else {
                                            vant.Toast('最多只能上传5张图片');
                                        }
                                    });
                                }

                            });
                        }
                    });
                },
                openFile() { //上传附件
                    if (this.isClaim) {
                        return
                    }
                    var _that = this;
                    api.actionSheet({
                        title: '',
                        cancelTitle: '取消',
                        buttons: ['音频', '视频']
                    }, (ret, err) => {
                        if (ret.buttonIndex == '1') {
                            _that.showAudio = true;
                        } else if (ret.buttonIndex == '2') {
                            api.getPicture({
                                sourceType: 'camera', //从相册中选择
                                mediaValue: 'video',
                                allowEdit: false,
                                destinationType: 'url',
                                videoQuality: 'high',
                                quality: 90,
                                saveToPhotoAlbum: false
                            }, function(ret, err) {
                                if (ret) {
                                    if (ret.duration > 25) {
                                        api.toast({
                                            msg: "视频时长最大为25秒",
                                            duration: 2000,
                                            location: 'top'
                                        });
                                    } else {
                                        if (ret.data != '') {
                                            _that.videoPath = ret.data;
                                            _that.showVideoDiv = true;
                                        }
                                    }
                                }
                            });
                        }
                    });
                },
                back() { //返回上一个页面
                    if (getTaskType == 'handle') { //任务处理 返回事件
                        api.sendEvent({
                            name: 'refreshCloudMyTask',
                            extra: {
                                type: '1'
                            }
                        });
                    } else if (getTaskType == 'claimTask') { //任务领用 返回事件
                        api.sendEvent({
                            name: 'refreshCloudClaim',
                            extra: {
                                type: '1'
                            }
                        });
                    }
                    api.closeWin();
                },
                delectPic(index) { //删除指定照片
                    var fs = api.require("fs");
                    if (this.isClaim) {
                        return
                    }
                    var _picArray = this.pic;
                    fs.remove({
                        path: _picArray[index]
                    });
                    _picArray.splice(index, 1);


                },
                getLocation() { //定位
                    this.Location = "正在定位中...";
                    this.Longitude = 0;
                    this.Latitude = 0;
                    pGetNameFromCoords(function(ret, err) {
                        if (ret.status) {
                            ApplyTaskVue.Longitude = ret.lon;
                            ApplyTaskVue.Latitude = ret.lat;
                            ApplyTaskVue.Location = ret.address;
                        } else {
                            ApplyTaskVue.Location = "定位失败";
                        }
                    });
                },
                hideAllSelect() {
                    this.showPicker = false;
                    this.showAreaSelect = false;
                },
                beforeClose(action, done) { //延期申请调取接口
                    if (action == "confirm") {
                        var delayTime = this.currentDate.getFullYear() + "-" +
                            ((this.currentDate.getMonth() + 1) < 10 ? "0" + (this.currentDate.getMonth() + 1) : (this.currentDate.getMonth() + 1)) + "-" +
                            (this.currentDate.getDate() < 10 ? "0" + this.currentDate.getDate() : this.currentDate.getDate()) + "  " +
                            (this.currentDate.getHours() < 10 ? "0" + this.currentDate.getHours() : this.currentDate.getHours()) + ":" +
                            (this.currentDate.getMinutes() < 10 ? "0" + this.currentDate.getMinutes() : this.currentDate.getMinutes()) + ":00";
                        var body = {
                            'Id': '',
                            'InstanceId': this.dataObj.WorkflowId, //流程Id
                            'EmployeeID': this.dataObj.ActivityId, //节点Id
                            'stepId': this.dataObj.StepId, //指向Id
                            'TypeId': this.dataObj.ServiceTypeId, //流程类型
                            'IsReassign': 2, //  是否转办、延期 0：不转办也不延期，1：转办，2：延期
                            'Content': this.dayHourText, //备注
                            // 'Id':,//轨迹ID
                            'DeferredTime': delayTime, //DeferredTime,//延期时间

                        };
                        bwfnPost('MMS110', body, 'application/json', false, false, (ret, err) => {
                            api.hideProgress();
                            if (ret) {
                                done();
                                if (ret.Status == 0) {
                                    api.toast({
                                        msg: '申请成功',
                                        duration: 2000,
                                        location: 'top'
                                    });
                                    if (getTaskType == 'handle') { //任务处理 返回事件
                                        api.sendEvent({
                                            name: 'refreshCloudMyTask',
                                            extra: {
                                                type: '1'
                                            }
                                        });
                                    } else if (getTaskType == 'claimTask') { //任务领用 返回事件
                                        api.sendEvent({
                                            name: 'refreshCloudClaim',
                                            extra: {
                                                type: '1'
                                            }
                                        });
                                    }
                                    setTimeout(function() {
                                        api.closeWin();
                                    }, 1000);
                                }
                            } else {
                                api.toast({
                                    msg: err.msg,
                                    duration: 2000,
                                    location: 'top'
                                });
                            }
                        });
                    } else if (action == 'cancel') {
                        done();
                    }
                },
                showDatePicker() {
                    if (!this.showDate) {
                        this.showDate = true;
                    }
                },
                openMap() { //打开地图页
                    if (this.isClaim) {
                        return
                    }
                    api.openWin({
                        name: 'NavigationMap',
                        url: './NavigationMap.html',
                        pageParam: {
                            ApplyLon: this.ApplyLon, //申请任务时纬度
                            ApplyLat: this.ApplyLat, //申请任务时纬度
                        }
                    });
                },
                callPhone(Phone) { //拨打抄表员电话
                    api.call({
                        type: 'tel_prompt',
                        number: Phone
                    });
                },
                closeAudio() {
                    setTimeout(function() {
                        this.showAudio = false;
                    }, 100);
                },
                startAudioFnc() {
                    var _that = this;
                    var e = e || window.event;
                    e.stopPropagation();

                    api.startRecord({});
                    _that.timeId = setInterval(function() {
                        _that.AudioTime += 1;
                        if (_that.AudioTime == 60) {
                            clearInterval(_that.timeId);
                            _that.stopAudioFnc();
                        }
                    }, 1000)
                },
                stopAudioFnc() {
                    var _that = this;
                    api.stopRecord(function(ret, err) {

                        if (ret) {
                            if (ret.path != '') {
                                _that.audioPath = ret.path;

                                _that.showAudioDiv = true;

                            }

                            _that.showAudio = false;
                            _that.AudioTime = 0;

                            clearInterval(_that.timeId);
                        }
                    });
                },
                playVideo() {
                    var _that = this;
                    api.openVideo({
                        url: _that.videoPath
                    });
                },
                playAudio() {
                    var _that = this;
                    var audioStreamer = api.require('audioStreamer');
                    audioStreamer.openPlayer({
                        path: _that.audioPath,
                    }, function(ret) {
                        if (ret.status) {
                            console.log(JSON.stringify(ret));
                        }
                    });
                },
                DeleteVideo() {
                    var _that = this;
                    var e = e || window.event;
                    e.stopPropagation();
                    api.confirm({
                        title: '提示',
                        msg: '确认删除视频',
                        buttons: ['确定', '取消']
                    }, function(ret, err) {
                        if (ret.buttonIndex == 1) {
                            var fs = api.require('fs');
                            fs.remove({
                                path: _that.videoPath
                            }, function(ret, err) {
                                if (ret.status) {
                                    _that.videoPath = "";
                                    _that.showVideoDiv = false;
                                } else {
                                    console.log(JSON.stringify(err));
                                }
                            });
                        }
                    });
                },
                DeleteAudio() {
                    var _that = this;
                    var e = e || window.event;
                    e.stopPropagation();

                    api.confirm({
                        title: '提示',
                        msg: '确认删除音频',
                        buttons: ['确定', '取消']
                    }, function(ret, err) {
                        if (ret.buttonIndex == 1) {
                            var fs = api.require('fs');
                            fs.remove({
                                path: _that.audioPath
                            }, function(ret, err) {
                                if (ret.status) {
                                    _that.audioPath = "";
                                    _that.showAudioDiv = false;
                                } else {
                                    console.log(JSON.stringify(err));
                                }
                            });
                        }
                    });
                },
                openUserDetails() { //打开用户详情界面
                    var body = {
                        BookId: '',
                        ReaderId: '',
                        Code: this.CustomerCode,
                        BeginTime: '',
                        EndTime: '',
                        Obscure: '',
                        isWater: '',
                    };

                    fnPost('OSM002', body, 'application/json', false, false, (ret, err) => {
                        if (ret && ret.Status == 0) {
                            var data = JSON.parse(ret.Data);
                            if (data.length > 0 && data.length == 1) {
                                var result = JSON.parse(JSON.stringify(data[0]));
                                api.openWin({
                                    name: 'CustomerDetails',
                                    url: '../CustomerSearch/CustomerDetails.html',
                                    pageParam: result,
                                    allowEdit: true
                                });
                                api.hideProgress();
                            } else {
                                api.hideProgress();
                                vant.Toast("用户查询失败");
                            }
                        } else {
                            api.hideProgress();
                            vant.Toast("用户查询失败");
                        }
                    });
                },
                //查询本地数据
                selectLocalData() {
                    var _that = this;
                    db.selectSql({
                        name: 'Wsdatabase',
                        sql: "SELECT * FROM Review_TASK_BASIC_LIST WHERE ReqCode = '" + _that.dataObj.taskCode + "' AND isUploadAndSave != '1'"
                    }, function(ret, err) {
                        if (ret.status) {
                            if (ret.data.length > 0) {
                                var data = ret.data; // dataObj
                                _that.taskInfoData = data[0];
                                _that.showDetailVal(data);
                            }
                        } else {
                            console.log(JSON.stringify(err));
                        }
                    });
                },
                //确认本地是否有该条数据
                queryReviewData() {
                    var _that = this;
                    db.selectSql({
                        name: 'Wsdatabase',
                        sql: "SELECT * FROM Review_TASK_BASIC_LIST WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                    }, function(ret, err) {
                        if (ret.status) {
                            // console.log(JSON.stringify(ret));
                            if (ret.data.length > 0) {
                                _that.updateReviewData(_that.taskInfoData);
                            } else {
                                _that.insertReviewData(_that.taskInfoData);
                            }
                        } else {
                            console.log(JSON.stringify(err));
                        }
                    });
                },
                //插入基础数据
                insertReviewData(taskItem) {
                    var _that = this;
                    var db = api.require("db");
                    var insertSql = "INSERT INTO Review_TASK_BASIC_LIST VALUES (" +
                        "'" + taskItem.ReqCode + "'," +
                        "'" + taskItem.IsEnd + "'," +
                        "'" + taskItem.CustomerName + "'," +
                        "'" + taskItem.ServiceTypeId + "'," +
                        "'" + taskItem.CustomerCode + "'," +
                        "'" + taskItem.Address + "'," +
                        "'" + taskItem.Caliber + "'," +
                        "'" + taskItem.LastScale + "'," +
                        "'" + taskItem.NatureName + "'," +
                        "'" + taskItem.CreateTime + "'," +
                        "'" + taskItem.Location + "'," +
                        "'" + taskItem.TypeName + "'," +
                        "'" + taskItem.Remark + "'," +
                        "'" + taskItem.WorkflowId + "'," +
                        "'" + taskItem.ActivityId + "'," +
                        "'" + taskItem.ActivityCode + "'," +
                        "'" + taskItem.StepId + "'," +
                        "'" + taskItem.MeterRemark + "'," +
                        "'" + taskItem.Path + "'," +
                        "'" + taskItem.Processinglevelid + "'," +
                        "'" + taskItem.UsgentText + "'," +
                        "'" + taskItem.AreasName + "'," +
                        "'" + taskItem.Phone + "'," +
                        "'" + taskItem.SourceName + "'," +
                        "'" + taskItem.EndTime + "'," +
                        "'" + taskItem.OrderNo + "'," +
                        "'" + taskItem.AppAddress + "'," +
                        "'" + JSON.stringify(taskItem.Files) + "'," +
                        "'" + JSON.stringify(taskItem.Budgetaudit) + "', '','" + $api.getStorage('loginData').userName + "', '0','" + taskItem.ReaderName + "','" + taskItem.ReaderPhone + "','" + taskItem.InstallMode + "','" + taskItem.SbTypeId +
                        "','" + taskItem.Longitude + "," + taskItem.Latitude + "','" + taskItem.SurveyRemark + "')";
                    db.executeSql({
                        name: 'Wsdatabase',
                        sql: insertSql
                    }, function(ret, err) {
                        if (ret.status) {
                            console.log(JSON.stringify(ret));
                            _that.selectLocalData();
                        } else {
                            console.log(JSON.stringify(err));
                        }
                    });
                },
                // 更新基础数据
                updateReviewData(taskItem) {
                    var _that = this;
                    var updateSql = "UPDATE Review_TASK_BASIC_LIST SET " +
                        "IsEnd = '" + taskItem.IsEnd + "'," +
                        "CustomerName = '" + taskItem.CustomerName + "'," +
                        "ServiceTypeId = '" + taskItem.ServiceTypeId + "'," +
                        "CustomerCode = '" + taskItem.CustomerCode + "'," +
                        "Address = '" + taskItem.Address + "'," +
                        "Caliber = '" + taskItem.Caliber + "'," +
                        "LastScale = '" + taskItem.LastScale + "'," +
                        "NatureName = '" + taskItem.NatureName + "'," +
                        "CreateTime = '" + taskItem.CreateTime + "'," +
                        "Location = '" + taskItem.Location + "'," +
                        "TypeName = '" + taskItem.TypeName + "'," +
                        "Remark = '" + taskItem.Remark + "'," +
                        "WorkflowId = '" + taskItem.WorkflowId + "'," +
                        "ActivityId = '" + taskItem.ActivityId + "'," +
                        "ActivityCode = '" + taskItem.ActivityCode + "'," +
                        "StepId = '" + taskItem.StepId + "'," +
                        "MeterRemark = '" + taskItem.MeterRemark + "'," +
                        "Path = '" + taskItem.Path + "'," +
                        "Processinglevelid = '" + taskItem.Processinglevelid + "'," +
                        "UsgentText = '" + taskItem.UsgentText + "'," +
                        "AreasName = '" + taskItem.AreasName + "'," +
                        "Phone = '" + taskItem.Phone + "'," +
                        "SourceName = '" + taskItem.SourceName + "'," +
                        "EndTime = '" + taskItem.EndTime + "'," +
                        "OrderNo = '" + taskItem.OrderNo + "'," +
                        "AppAddress = '" + taskItem.AppAddress + "'," +
                        "Files = '" + JSON.stringify(taskItem.Files) + "'," +
                        "Budgetaudit = '" + JSON.stringify(taskItem.Budgetaudit) + "',SurveyRemark='" + taskItem.SurveyRemark + "',fieldOne='" + taskItem.ReaderName + "',fieldTwo='" + taskItem.ReaderPhone + "',fieldThree = '" + taskItem.InstallMode +
                        "',fieldFour = '" + taskItem.SbTypeId + "',fieldFive = '" + taskItem.Longitude + "," + taskItem.Latitude + "' WHERE ReqCode = '" + _that.dataObj.taskCode + "'";
                    db.executeSql({
                        name: 'Wsdatabase',
                        sql: updateSql
                    }, function(ret, err) {
                        if (ret.status) {
                            // console.log(JSON.stringify(ret));
                            if (taskItem.IsEnd != 1) {
                              var retTwo = db.executeSqlSync({
                                  name: 'Wsdatabase',
                                  sql: "UPDATE Review_TASK_HANDLED_LIST SET isUpload = '0' WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                              });
                              console.log(JSON.stringify(retTwo));
                              db.executeSql({
                                  name: 'Wsdatabase',
                                  sql: "UPDATE Review_TASK_BASIC_LIST SET isUploadAndSave = '0' WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                              }, function(ret, err){
                                  _that.selectLocalData();
                              });
                            }

                        }
                    });
                },
                //保存数据至本地
                saveDataLocal(saveData) {
                    var _that = this;
                    db.selectSql({
                        name: 'Wsdatabase',
                        sql: "SELECT * FROM Review_TASK_HANDLED_LIST WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                    }, function(ret, err) {
                        api.hideProgress();
                        if (ret.status) {
                            console.log(JSON.stringify(ret));
                            if (ret.data.length > 0) {
                                _that.updateHandled(saveData);
                            } else {
                                _that.insertHandled(saveData);
                            }
                        } else {
                            console.log(JSON.stringify(err));
                        }
                    });
                },
                //添加表务办理数据
                insertHandled(saveData) {
                    var _that = this;
                    var result = db.executeSqlSync({
                        name: 'Wsdatabase',
                        sql: "UPDATE Review_TASK_BASIC_LIST SET SaveTime = '" + _that.saveTime() + "', isUploadAndSave = '2' WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                    });
                    console.log(JSON.stringify(saveData));
                    console.log(JSON.stringify(result));
                    var insertSql = "INSERT INTO Review_TASK_HANDLED_LIST VALUES (" +
                        "'" + saveData.ReqCode + "'," +
                        "'" + saveData.Longitude + "'," +
                        "'" + saveData.Latitude + "'," +
                        "'" + saveData.Location + "'," +
                        "'" + saveData.Remark + "'," +
                        "'" + saveData.BeginScale + "'," +
                        "'" + saveData.LastReadScale + "'," +
                        "'" + saveData.OriginalScale + "'," +
                        "'" + saveData.OldAmount + "'," +
                        "'" + saveData.StampNo + "'," +
                        "'" + saveData.ComputeTypeId + "'," +
                        "'" + saveData.Caliber + "'," +
                        "'" + saveData.MeterTypeId + "'," +
                        "'" + saveData.NamePlateId + "'," +
                        "'" + saveData.ModelId + "'," +
                        "'" + saveData.InstallationModeId + "'," +
                        "'" + saveData.ConcreteScale + "'," +
                        "'" + saveData.TypeId + "'," +
                        "'" + saveData.filePath + "'," +
                        "'" + saveData.audioPath + "'," +
                        "'" + saveData.videoPath + "'," +
                        "''," +
                        "'0'," +
                        "'" + $api.getStorage('loginData').userName + "'," +
                        "'4','','','','','')";
                    db.executeSql({
                        name: 'Wsdatabase',
                        sql: insertSql
                    }, function(ret, err) {
                        _that.isSubmit = false;
                        if (ret.status) {
                            pUpdataMytaskSheetsStatus(dataObj); //修改云平台数据状态 6-6 zxf
                            console.log(JSON.stringify(ret));
                            vant.Toast('数据保存成功');
                        } else {
                            console.log(JSON.stringify(err));
                            vant.Toast('数据保存失败：' + err.msg);
                        }
                    });
                },
                //更新表务办理数据
                updateHandled(saveData) {
                    var _that = this;
                    var result = db.executeSqlSync({
                        name: 'Wsdatabase',
                        sql: "UPDATE Review_TASK_BASIC_LIST SET SaveTime = '" + _that.saveTime() + "', isUploadAndSave = '2' WHERE ReqCode = '" + _that.dataObj.taskCode + "'"
                    });
                    console.log(JSON.stringify(saveData));
                    console.log(JSON.stringify(result));
                    var updateSql = "UPDATE Review_TASK_HANDLED_LIST SET " +
                        "Longitude = '" + saveData.Longitude + "'," +
                        "Latitude = '" + saveData.Latitude + "'," +
                        "Location = '" + saveData.Location + "'," +
                        "Remark = '" + saveData.Remark + "'," +
                        "BeginScale = '" + saveData.BeginScale + "'," +
                        "LastReadScale = '" + saveData.LastReadScale + "'," +
                        "OriginalScale = '" + saveData.OriginalScale + "'," +
                        "OldAmount = '" + saveData.OldAmount + "'," +
                        "StampNo = '" + saveData.StampNo + "'," +
                        "ComputeTypeId = '" + saveData.ComputeTypeId + "'," +
                        "Caliber = '" + saveData.Caliber + "'," +
                        "MeterTypeId = '" + saveData.MeterTypeId + "'," +
                        "NamePlateId = '" + saveData.NamePlateId + "'," +
                        "ModelId = '" + saveData.ModelId + "'," +
                        "InstallationModeId = '" + saveData.InstallationModeId + "'," +
                        "ConcreteScale = '" + saveData.ConcreteScale + "'," +
                        "TypeId = '" + saveData.TypeId + "'," +
                        "filePath = '" + saveData.filePath + "'," +
                        "audioPath = '" + saveData.audioPath + "'," +
                        "videoPath = '" + saveData.videoPath + "'," +
                        "Title = ''," +
                        "AttachmentType = '4' WHERE ReqCode = '" + _that.dataObj.taskCode + "'";
                    db.executeSql({
                        name: 'Wsdatabase',
                        sql: updateSql
                    }, function(ret, err) {
                        _that.isSubmit = false;
                        if (ret.status) {
                            pUpdataMytaskSheetsStatus(dataObj); //修改云平台数据状态 6-6 zxf
                            console.log(JSON.stringify(ret));
                            vant.Toast('数据保存成功');
                        } else {
                            console.log(JSON.stringify(err));
                            vant.Toast('数据保存失败：' + err.msg);
                        }
                    });
                },
                //保存时间
                saveTime() {
                    var myDate = new Date();
                    return myDate.getFullYear() + "-" + ((myDate.getMonth() + 1) < 10 ? "0" + (myDate.getMonth() + 1) : (myDate.getMonth() + 1)) + "-" + (myDate.getDate() < 10 ? "0" + (myDate.getDate()) : (myDate.getDate()));
                }
            },

            mounted: function() { //挂载完成后调用
                this.getDetail();
                this.getLocation();
            }
        })
    }
</script>

</html>
